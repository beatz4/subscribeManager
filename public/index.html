<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Subscription Manager</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --surface-2: #1a1a26;
  --border: #2a2a3a;
  --text: #e8e8f0;
  --text-muted: #7a7a8e;
  --accent: #6c5ce7;
  --accent-glow: rgba(108, 92, 231, 0.3);
  --green: #00b894;
  --orange: #fdcb6e;
  --red: #e17055;
  --pink: #fd79a8;
  --blue: #74b9ff;
  --radius: 16px;
}

[data-theme="light"] {
  --bg: #f0f2f5;
  --surface: #ffffff;
  --surface-2: #f5f5f7;
  --border: #e0e0e6;
  --text: #1a1a2e;
  --text-muted: #6b6b80;
  --accent-glow: rgba(108, 92, 231, 0.15);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Noto Sans KR', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle at 30% 20%, rgba(108,92,231,0.06) 0%, transparent 50%),
              radial-gradient(circle at 70% 80%, rgba(253,121,168,0.04) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

.app { position: relative; z-index: 1; max-width: 900px; margin: 0 auto; padding: 24px 20px 100px; }

/* Header */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 32px 0 40px;
}

.logo {
  display: flex;
  align-items: center;
  gap: 12px;
}

.logo-icon {
  width: 44px;
  height: 44px;
  background: linear-gradient(135deg, var(--accent), var(--pink));
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  box-shadow: 0 4px 20px var(--accent-glow);
}

.logo h1 {
  font-family: 'Space Mono', monospace;
  font-size: 22px;
  font-weight: 700;
  letter-spacing: -0.5px;
}

.logo h1 span { color: var(--accent); }

.btn-add {
  background: var(--accent);
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  font-family: 'Noto Sans KR', sans-serif;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 4px 16px var(--accent-glow);
}

.btn-theme {
  width: 44px;
  height: 44px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--surface);
  cursor: pointer;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.btn-theme:hover {
  border-color: var(--accent);
  transform: translateY(-2px);
}

.btn-lang {
  height: 44px;
  padding: 0 14px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--surface);
  cursor: pointer;
  font-size: 12px;
  font-family: 'Space Mono', monospace;
  font-weight: 700;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  letter-spacing: 0.5px;
}

.btn-lang:hover {
  border-color: var(--accent);
  color: var(--accent);
  transform: translateY(-2px);
}

.btn-add:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px var(--accent-glow);
}

/* Summary Cards */
.summary {
  display: grid;
  grid-template-columns: 1fr 1fr auto auto;
  gap: 16px;
  margin-bottom: 36px;
}

.summary-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  position: relative;
  overflow: hidden;
}

.summary-card::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
}

.summary-card:nth-child(1)::after { background: linear-gradient(90deg, var(--accent), var(--pink)); }
.summary-card:nth-child(2)::after { background: linear-gradient(90deg, var(--green), var(--blue)); }
.summary-card:nth-child(3)::after { background: linear-gradient(90deg, var(--orange), var(--red)); }
.summary-card:nth-child(4)::after { background: linear-gradient(90deg, var(--text-muted), var(--border)); }

.summary-card.small {
  padding: 18px;
  min-width: 100px;
}

.summary-card.small .summary-value {
  font-size: 24px;
}

.summary-label {
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 8px;
  font-family: 'Space Mono', monospace;
}

.summary-value {
  font-size: 32px;
  font-weight: 900;
  font-family: 'Space Mono', monospace;
}

.summary-sub {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 4px;
}

/* Filter Bar */
.filter-bar {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
  flex-wrap: wrap;
  align-items: center;
}

.filter-spacer { flex: 1; }

.btn-delete-all {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-muted);
  padding: 8px 16px;
  border-radius: 100px;
  font-size: 13px;
  cursor: pointer;
  font-family: 'Noto Sans KR', sans-serif;
  transition: all 0.2s;
}

.btn-delete-all:hover {
  border-color: var(--red);
  color: var(--red);
  background: rgba(225, 112, 85, 0.1);
}

.filter-btn {
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text-muted);
  padding: 8px 18px;
  border-radius: 100px;
  font-size: 13px;
  cursor: pointer;
  font-family: 'Noto Sans KR', sans-serif;
  transition: all 0.2s;
}

.filter-btn.active {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
}

.filter-btn:hover:not(.active) {
  border-color: var(--accent);
  color: var(--text);
}

/* Subscription List */
.sub-list { display: flex; flex-direction: column; gap: 12px; }

.sub-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px 24px;
  display: flex;
  align-items: center;
  gap: 16px;
  transition: all 0.2s;
  cursor: pointer;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.sub-card:hover {
  border-color: var(--accent);
  transform: translateX(4px);
  box-shadow: -4px 0 20px var(--accent-glow);
}

.sub-icon {
  width: 48px;
  height: 48px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  flex-shrink: 0;
}

.sub-info { flex: 1; min-width: 0; }

.sub-name {
  font-weight: 700;
  font-size: 16px;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.sub-category {
  font-size: 11px;
  padding: 2px 8px;
  border-radius: 100px;
  background: var(--surface-2);
  color: var(--text-muted);
  font-family: 'Space Mono', monospace;
}

.sub-detail {
  font-size: 13px;
  color: var(--text-muted);
}

.sub-price {
  text-align: right;
  flex-shrink: 0;
}

.sub-price-value {
  font-family: 'Space Mono', monospace;
  font-size: 18px;
  font-weight: 700;
}

.sub-price-cycle {
  font-size: 12px;
  color: var(--text-muted);
}

.sub-actions {
  display: flex;
  gap: 6px;
  flex-shrink: 0;
}

.btn-icon {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: all 0.2s;
}

.btn-icon:hover {
  border-color: var(--red);
  color: var(--red);
  background: rgba(225, 112, 85, 0.1);
}

.btn-icon.toggle {
  font-size: 18px;
}

.btn-icon.toggle:hover {
  border-color: var(--green);
  color: var(--green);
  background: rgba(0, 184, 148, 0.1);
}

.sub-card.inactive {
  opacity: 0.45;
}

.sub-card.inactive .sub-price-value {
  text-decoration: line-through;
}

.btn-icon.edit:hover {
  border-color: var(--blue);
  color: var(--blue);
  background: rgba(116, 185, 255, 0.1);
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 80px 20px;
  color: var(--text-muted);
}

.empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
.empty-state p { font-size: 16px; }

/* Modal */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px);
  z-index: 100;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s;
}

.modal-overlay.active { opacity: 1; visibility: visible; }

.modal {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 36px;
  width: 100%;
  max-width: 480px;
  max-height: 90vh;
  overflow-y: auto;
  transform: scale(0.95) translateY(20px);
  transition: transform 0.3s;
}

.modal-overlay.active .modal { transform: scale(1) translateY(0); }

.modal h2 {
  font-size: 20px;
  margin-bottom: 28px;
  font-weight: 700;
}

.form-group { margin-bottom: 20px; }

.form-group label {
  display: block;
  font-size: 12px;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 8px;
  font-family: 'Space Mono', monospace;
}

.form-group input,
.form-group select {
  width: 100%;
  background: var(--surface-2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  color: var(--text);
  font-size: 15px;
  font-family: 'Noto Sans KR', sans-serif;
  outline: none;
  transition: border-color 0.2s;
}

.form-group input:focus,
.form-group select:focus {
  border-color: var(--accent);
}

.form-group select { cursor: pointer; }
.form-group select option { background: var(--surface); }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

.status-toggle {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
  user-select: none;
}

.status-toggle-track {
  width: 48px;
  height: 26px;
  background: var(--border);
  border-radius: 13px;
  position: relative;
  transition: background 0.2s;
}

.status-toggle.active .status-toggle-track {
  background: var(--green);
}

.status-toggle-thumb {
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  position: absolute;
  top: 3px;
  left: 3px;
  transition: transform 0.2s;
}

.status-toggle.active .status-toggle-thumb {
  transform: translateX(22px);
}

.status-toggle-label {
  font-size: 14px;
  color: var(--text-muted);
}

.status-toggle.active .status-toggle-label {
  color: var(--green);
}

.color-picker {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.color-option {
  width: 36px;
  height: 36px;
  border-radius: 10px;
  border: 2px solid transparent;
  cursor: pointer;
  transition: all 0.2s;
}

.color-option.selected {
  border-color: white;
  transform: scale(1.15);
  box-shadow: 0 0 12px rgba(255,255,255,0.2);
}

.modal-actions {
  display: flex;
  gap: 12px;
  margin-top: 28px;
}

.btn-cancel {
  flex: 1;
  padding: 14px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-muted);
  font-size: 15px;
  cursor: pointer;
  font-family: 'Noto Sans KR', sans-serif;
  transition: all 0.2s;
}

.btn-cancel:hover { border-color: var(--text-muted); color: var(--text); }

.btn-save {
  flex: 1;
  padding: 14px;
  border-radius: 12px;
  border: none;
  background: var(--accent);
  color: white;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  font-family: 'Noto Sans KR', sans-serif;
  transition: all 0.2s;
  box-shadow: 0 4px 16px var(--accent-glow);
}

.btn-save:hover { transform: translateY(-1px); box-shadow: 0 8px 24px var(--accent-glow); }

/* Toast */
.toast {
  position: fixed;
  bottom: 32px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--surface-2);
  border: 1px solid var(--border);
  padding: 14px 24px;
  border-radius: 14px;
  font-size: 14px;
  z-index: 200;
  transition: transform 0.3s;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4);
}

.toast.show { transform: translateX(-50%) translateY(0); }

/* Loading */
.loading {
  display: flex;
  justify-content: center;
  padding: 60px;
}

.spinner {
  width: 36px;
  height: 36px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* Click blocker */
.click-blocker {
  position: fixed;
  inset: 0;
  z-index: 9999;
  cursor: wait;
  display: none;
}
.click-blocker.active { display: block; }

/* Responsive */
@media (max-width: 600px) {
  .summary { grid-template-columns: repeat(2, 1fr); }
  .summary-card { padding: 18px; }
  .summary-value { font-size: 26px; }
  .sub-card { padding: 16px; }
  .sub-icon { width: 40px; height: 40px; font-size: 18px; }
  .sub-price-value { font-size: 15px; }
  header { flex-direction: column; gap: 20px; align-items: stretch; }
  .btn-add { justify-content: center; }
  .form-row { grid-template-columns: 1fr; }
  .modal { padding: 24px; }
}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="logo">
      <div class="logo-icon">‚üê</div>
      <h1>SUBSCRIBE<span>.</span>MANAGER</h1>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <button class="btn-lang" onclick="toggleLang()" id="langBtn">KO</button>
      <button class="btn-theme" onclick="toggleTheme()" id="themeBtn" title="Theme">üåô</button>
      <button class="btn-add" onclick="openModal()">
        <span>+</span> <span data-i18n="addBtn">Add</span>
      </button>
    </div>
  </header>

  <div class="summary">
    <div class="summary-card">
      <div class="summary-label" data-i18n="labelMonthly">Monthly</div>
      <div class="summary-value" id="totalMonthly">‚Ç©0</div>
      <div class="summary-sub" data-i18n="subMonthly">Monthly total</div>
    </div>
    <div class="summary-card">
      <div class="summary-label" data-i18n="labelYearly">Yearly</div>
      <div class="summary-value" id="totalYearly">‚Ç©0</div>
      <div class="summary-sub" data-i18n="subYearly">Yearly estimate</div>
    </div>
    <div class="summary-card small">
      <div class="summary-label" data-i18n="labelActive">Active</div>
      <div class="summary-value" id="totalCount">0</div>
      <div class="summary-sub" data-i18n="subActive">Active subs</div>
    </div>
    <div class="summary-card small">
      <div class="summary-label" data-i18n="labelInactive">Inactive</div>
      <div class="summary-value" id="inactiveCount">0</div>
      <div class="summary-sub" data-i18n="subInactive">Inactive subs</div>
    </div>
  </div>

  <div class="filter-bar">
    <button class="filter-btn active" data-filter="all" onclick="setFilter('all')" data-i18n="filterAll">All</button>
    <button class="filter-btn" data-filter="entertainment" onclick="setFilter('entertainment')" data-i18n="filterEntertainment">Entertainment</button>
    <button class="filter-btn" data-filter="productivity" onclick="setFilter('productivity')" data-i18n="filterProductivity">Productivity</button>
    <button class="filter-btn" data-filter="lifestyle" onclick="setFilter('lifestyle')" data-i18n="filterLifestyle">Lifestyle</button>
    <button class="filter-btn" data-filter="etc" onclick="setFilter('etc')" data-i18n="filterEtc">Other</button>
    <div class="filter-spacer"></div>
    <button class="btn-delete-all" onclick="deleteAll()" data-i18n="deleteAll">Delete All</button>
  </div>

  <div id="subList" class="sub-list">
    <div class="loading"><div class="spinner"></div></div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h2 id="modalTitle">Add Subscription</h2>
    <input type="hidden" id="editId">

    <div class="form-group">
      <label data-i18n="labelName">Service Name</label>
      <input type="text" id="subName" placeholder="Netflix, Spotify...">
    </div>

    <div class="form-row">
      <div class="form-group">
        <label data-i18n="labelPrice">Price (KRW)</label>
        <input type="number" id="subPrice" placeholder="13500" step="1000" min="0" value="13500">
      </div>
      <div class="form-group">
        <label data-i18n="labelCycle">Billing Cycle</label>
        <select id="subCycle">
          <option value="monthly" data-i18n="cycleMonthly">Monthly</option>
          <option value="yearly" data-i18n="cycleYearly">Yearly</option>
          <option value="weekly" data-i18n="cycleWeekly">Weekly</option>
        </select>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label data-i18n="labelCategory">Category</label>
        <select id="subCategory">
          <option value="entertainment" data-i18n="catEntertainment">Entertainment</option>
          <option value="productivity" data-i18n="catProductivity">Productivity</option>
          <option value="lifestyle" data-i18n="catLifestyle">Lifestyle</option>
          <option value="etc" data-i18n="catEtc">Other</option>
        </select>
      </div>
      <div class="form-group">
        <label data-i18n="labelBillingDay">Billing Day</label>
        <input type="number" id="subBillingDay" min="1" max="31" placeholder="10" value="10">
      </div>
    </div>

    <div class="form-group">
      <label data-i18n="labelEmoji">Icon (Emoji)</label>
      <input type="text" id="subEmoji" placeholder="üé¨" maxlength="4">
    </div>

    <div class="form-group">
      <label data-i18n="labelColor">Color</label>
      <div class="color-picker" id="colorPicker">
        <div class="color-option selected" data-color="#6c5ce7" style="background:#6c5ce7"></div>
        <div class="color-option" data-color="#e17055" style="background:#e17055"></div>
        <div class="color-option" data-color="#00b894" style="background:#00b894"></div>
        <div class="color-option" data-color="#fdcb6e" style="background:#fdcb6e"></div>
        <div class="color-option" data-color="#fd79a8" style="background:#fd79a8"></div>
        <div class="color-option" data-color="#74b9ff" style="background:#74b9ff"></div>
        <div class="color-option" data-color="#a29bfe" style="background:#a29bfe"></div>
        <div class="color-option" data-color="#fab1a0" style="background:#fab1a0"></div>
      </div>
    </div>

    <div class="form-group">
      <label data-i18n="labelMemo">Memo (optional)</label>
      <input type="text" id="subMemo" placeholder="Family plan">
    </div>

    <div class="form-group" id="statusGroup" style="display:none">
      <label data-i18n="labelStatus">Status</label>
      <div class="status-toggle" id="statusToggle" onclick="toggleStatus()">
        <div class="status-toggle-track">
          <div class="status-toggle-thumb"></div>
        </div>
        <span class="status-toggle-label">Active</span>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()" data-i18n="cancel">Cancel</button>
      <button class="btn-save" data-i18n="save">Save</button>
    </div>
  </div>
</div>

<div class="click-blocker" id="clickBlocker"></div>
<div class="toast" id="toast"></div>

<script>
const API = '/api';
let subscriptions = [];
let currentFilter = 'all';
let selectedColor = '#6c5ce7';
let selectedActive = true;
let currentLang = 'en';
let isSaving = false;

// Translations
const translations = {
  en: {
    pageTitle: 'Subscription Manager',
    addBtn: 'Add',
    labelMonthly: 'Monthly',
    labelYearly: 'Yearly',
    labelActive: 'Active',
    labelInactive: 'Inactive',
    subMonthly: 'Monthly total',
    subYearly: 'Yearly estimate',
    subActive: 'Active subs',
    subInactive: 'Inactive subs',
    filterAll: 'All',
    filterEntertainment: 'Entertainment',
    filterProductivity: 'Productivity',
    filterLifestyle: 'Lifestyle',
    filterEtc: 'Other',
    deleteAll: 'Delete All',
    empty: 'No subscriptions yet',
    modalAdd: 'Add Subscription',
    modalEdit: 'Edit Subscription',
    labelName: 'Service Name',
    labelPrice: 'Price (KRW)',
    labelCycle: 'Billing Cycle',
    labelCategory: 'Category',
    labelBillingDay: 'Billing Day',
    labelEmoji: 'Icon (Emoji)',
    labelColor: 'Color',
    labelMemo: 'Memo (optional)',
    labelStatus: 'Status',
    cycleMonthly: 'Monthly',
    cycleYearly: 'Yearly',
    cycleWeekly: 'Weekly',
    catEntertainment: 'Entertainment',
    catProductivity: 'Productivity',
    catLifestyle: 'Lifestyle',
    catEtc: 'Other',
    statusActive: 'Active',
    statusInactive: 'Inactive',
    cancel: 'Cancel',
    save: 'Save',
    saving: 'Saving...',
    toastValidation: '‚ö†Ô∏è Please enter service name and price',
    toastDuplicate: '‚ö†Ô∏è A subscription with the same name and category already exists',
    toastAdded: '‚úÖ Added successfully',
    toastUpdated: '‚úÖ Updated successfully',
    toastSaveFail: '‚ùå Save failed: ',
    toastActivated: 'üîî Subscription activated',
    toastDeactivated: 'üîï Subscription deactivated',
    toastToggleFail: '‚ùå Failed to change status',
    toastDeleted: 'üóëÔ∏è Deleted',
    toastDeleteFail: '‚ùå Delete failed',
    toastNoSubs: 'No subscriptions to delete',
    toastDeleteAll: 'üóëÔ∏è All subscriptions deleted',
    toastDeleteAllFail: '‚ùå Delete failed',
    confirmDelete: 'Delete this subscription?',
    catLabel: { entertainment: 'Enter.', productivity: 'Prod.', lifestyle: 'Lifestyle', etc: 'Other' },
    cycleLabel: { monthly: '/ mo', yearly: '/ yr', weekly: '/ wk' },
  },
  ko: {
    pageTitle: 'Íµ¨ÎèÖ Í¥ÄÎ¶¨',
    addBtn: 'Íµ¨ÎèÖ Ï∂îÍ∞Ä',
    labelMonthly: 'Monthly',
    labelYearly: 'Yearly',
    labelActive: 'Active',
    labelInactive: 'Inactive',
    subMonthly: 'ÏõîÍ∞Ñ Ï¥ù Íµ¨ÎèÖÎ£å',
    subYearly: 'Ïó∞Í∞Ñ ÏòàÏÉÅ ÎπÑÏö©',
    subActive: 'ÌôúÏÑ± Íµ¨ÎèÖ',
    subInactive: 'ÎπÑÌôúÏÑ± Íµ¨ÎèÖ',
    filterAll: 'Ï†ÑÏ≤¥',
    filterEntertainment: 'ÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏',
    filterProductivity: 'ÏÉùÏÇ∞ÏÑ±',
    filterLifestyle: 'ÎùºÏù¥ÌîÑÏä§ÌÉÄÏùº',
    filterEtc: 'Í∏∞ÌÉÄ',
    deleteAll: 'Ï†ÑÏ≤¥ ÏÇ≠Ï†ú',
    empty: 'Îì±Î°ùÎêú Íµ¨ÎèÖÏù¥ ÏóÜÏäµÎãàÎã§',
    modalAdd: 'Íµ¨ÎèÖ Ï∂îÍ∞Ä',
    modalEdit: 'Íµ¨ÎèÖ ÏàòÏ†ï',
    labelName: 'ÏÑúÎπÑÏä§Î™Ö',
    labelPrice: 'Í∏àÏï° (Ïõê)',
    labelCycle: 'Í≤∞Ï†ú Ï£ºÍ∏∞',
    labelCategory: 'Ïπ¥ÌÖåÍ≥†Î¶¨',
    labelBillingDay: 'Í≤∞Ï†úÏùº',
    labelEmoji: 'ÏïÑÏù¥ÏΩò (Ïù¥Î™®ÏßÄ)',
    labelColor: 'ÏÉâÏÉÅ',
    labelMemo: 'Î©îÎ™® (ÏÑ†ÌÉù)',
    labelStatus: 'ÏÉÅÌÉú',
    cycleMonthly: 'ÏõîÍ∞Ñ',
    cycleYearly: 'Ïó∞Í∞Ñ',
    cycleWeekly: 'Ï£ºÍ∞Ñ',
    catEntertainment: 'ÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏',
    catProductivity: 'ÏÉùÏÇ∞ÏÑ±',
    catLifestyle: 'ÎùºÏù¥ÌîÑÏä§ÌÉÄÏùº',
    catEtc: 'Í∏∞ÌÉÄ',
    statusActive: 'ÌôúÏÑ±',
    statusInactive: 'ÎπÑÌôúÏÑ±',
    cancel: 'Ï∑®ÏÜå',
    save: 'Ï†ÄÏû•',
    saving: 'Ï†ÄÏû• Ï§ë...',
    toastValidation: '‚ö†Ô∏è ÏÑúÎπÑÏä§Î™ÖÍ≥º Í∏àÏï°ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî',
    toastDuplicate: '‚ö†Ô∏è Í∞ôÏùÄ Ïù¥Î¶ÑÍ≥º Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò Íµ¨ÎèÖÏù¥ Ïù¥ÎØ∏ Ï°¥Ïû¨Ìï©ÎãàÎã§',
    toastAdded: '‚úÖ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§',
    toastUpdated: '‚úÖ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§',
    toastSaveFail: '‚ùå Ï†ÄÏû• Ïã§Ìå®: ',
    toastActivated: 'üîî Íµ¨ÎèÖ ÌôúÏÑ±Ìôî',
    toastDeactivated: 'üîï Íµ¨ÎèÖ ÎπÑÌôúÏÑ±Ìôî',
    toastToggleFail: '‚ùå ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®',
    toastDeleted: 'üóëÔ∏è ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§',
    toastDeleteFail: '‚ùå ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§',
    toastNoSubs: 'ÏÇ≠Ï†úÌï† Íµ¨ÎèÖÏù¥ ÏóÜÏäµÎãàÎã§',
    toastDeleteAll: 'üóëÔ∏è Ï†ÑÏ≤¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§',
    toastDeleteAllFail: '‚ùå ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§',
    confirmDelete: 'Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?',
    catLabel: { entertainment: 'ÏóîÌÑ∞', productivity: 'ÏÉùÏÇ∞ÏÑ±', lifestyle: 'ÎùºÏù¥ÌîÑ', etc: 'Í∏∞ÌÉÄ' },
    cycleLabel: { monthly: '/ Ïõî', yearly: '/ ÎÖÑ', weekly: '/ Ï£º' },
  }
};

function t(key) {
  return translations[currentLang][key] ?? translations.en[key] ?? key;
}

function applyTranslations() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = t(el.dataset.i18n);
  });
  document.title = t('pageTitle');
  document.getElementById('langBtn').textContent = currentLang === 'en' ? 'KO' : 'EN';
  document.documentElement.lang = currentLang;
}

function toggleLang() {
  currentLang = currentLang === 'en' ? 'ko' : 'en';
  localStorage.setItem('lang', currentLang);
  applyTranslations();
  render();
}

// Color picker
document.querySelectorAll('.color-option').forEach(el => {
  el.addEventListener('click', () => {
    document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
    el.classList.add('selected');
    selectedColor = el.dataset.color;
  });
});

// API calls
async function fetchSubs() {
  try {
    const res = await fetch(`${API}/subscriptions`);
    if (!res.ok) throw new Error('Failed to fetch');
    subscriptions = await res.json();
  } catch (e) {
    console.error(e);
    subscriptions = [];
  }
  render();
}

async function saveSub() {
  const saveBtn = document.querySelector('.btn-save');
  saveBtn.onclick = null; // ÌÅêÏóê ÏåìÏù∏ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï¶âÏãú Î¨¥Î†•Ìôî

  if (isSaving) return;

  const id = document.getElementById('editId').value;
  const data = {
    name: document.getElementById('subName').value.trim(),
    price: parseInt(document.getElementById('subPrice').value) || 0,
    cycle: document.getElementById('subCycle').value,
    category: document.getElementById('subCategory').value,
    billingDay: parseInt(document.getElementById('subBillingDay').value) || 1,
    emoji: document.getElementById('subEmoji').value || 'üì¶',
    color: selectedColor,
    memo: document.getElementById('subMemo').value.trim(),
    active: selectedActive,
  };

  if (!data.name || !data.price) {
    saveBtn.onclick = saveSub;
    showToast(t('toastValidation'));
    return;
  }

  const isDuplicate = subscriptions.some(s =>
    s.id !== id &&
    s.name.trim().toLowerCase() === data.name.toLowerCase() &&
    s.category === data.category
  );
  if (isDuplicate) {
    saveBtn.onclick = saveSub;
    showToast(t('toastDuplicate'));
    return;
  }

  isSaving = true;
  saveBtn.disabled = true;
  saveBtn.textContent = t('saving');
  closeModal();
  document.getElementById('clickBlocker').classList.add('active');

  try {
    let res;
    if (id) {
      res = await fetch(`${API}/subscriptions/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
    } else {
      res = await fetch(`${API}/subscriptions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
    }

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || `HTTP ${res.status}`);
    }

    await fetchSubs();
    showToast(id ? t('toastUpdated') : t('toastAdded'));
  } catch (e) {
    console.error('saveSub error:', e);
    showToast(t('toastSaveFail') + e.message);
  } finally {
    isSaving = false;
    saveBtn.disabled = false;
    saveBtn.textContent = t('save');
    document.getElementById('clickBlocker').classList.remove('active');
  }
}

async function toggleSub(id) {
  const s = subscriptions.find(x => x.id === id);
  if (!s) return;
  const newActive = s.active === false ? true : false;
  try {
    const res = await fetch(`${API}/subscriptions/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ active: newActive }),
    });
    if (!res.ok) throw new Error('Toggle failed');
    await fetchSubs();
    showToast(newActive ? t('toastActivated') : t('toastDeactivated'));
  } catch (e) {
    showToast(t('toastToggleFail'));
  }
}

async function deleteSub(id) {
  if (!confirm(t('confirmDelete'))) return;
  try {
    await fetch(`${API}/subscriptions/${id}`, { method: 'DELETE' });
    showToast(t('toastDeleted'));
    await fetchSubs();
  } catch (e) {
    showToast(t('toastDeleteFail'));
  }
}

async function deleteAll() {
  const filtered = currentFilter === 'all'
    ? subscriptions
    : subscriptions.filter(s => s.category === currentFilter);

  if (!filtered.length) {
    showToast(t('toastNoSubs'));
    return;
  }
  const msg = currentLang === 'en'
    ? `Delete all ${filtered.length} subscriptions?`
    : `Ï¥ù ${filtered.length}Í∞úÏùò Íµ¨ÎèÖÏùÑ Î™®Îëê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`;
  if (!confirm(msg)) return;
  try {
    if (currentFilter === 'all') {
      const res = await fetch(`${API}/subscriptions`, { method: 'DELETE' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
    } else {
      for (const s of filtered) {
        await fetch(`${API}/subscriptions/${s.id}`, { method: 'DELETE' });
      }
    }
    showToast(t('toastDeleteAll'));
    await fetchSubs();
  } catch (e) {
    showToast(t('toastDeleteAllFail'));
  }
}

// Rendering
function render() {
  const list = document.getElementById('subList');
  const filtered = currentFilter === 'all' ? subscriptions : subscriptions.filter(s => s.category === currentFilter);

  if (filtered.length === 0) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="icon">üì≠</div>
        <p>${t('empty')}</p>
      </div>`;
  } else {
    list.innerHTML = filtered.map(s => {
      const billingDetail = currentLang === 'en'
        ? `Billed on ${s.billingDay}${s.memo ? ' ¬∑ ' + s.memo : ''}`
        : `Îß§Ïõî ${s.billingDay}Ïùº Í≤∞Ï†ú${s.memo ? ' ¬∑ ' + s.memo : ''}`;
      return `
      <div class="sub-card${s.active === false ? ' inactive' : ''}" style="animation-delay: ${filtered.indexOf(s) * 0.05}s">
        <div class="sub-icon" style="background:${s.color}22; color:${s.color}">${s.emoji}</div>
        <div class="sub-info">
          <div class="sub-name">
            ${s.name}
            <span class="sub-category">${getCategoryLabel(s.category)}</span>
          </div>
          <div class="sub-detail">${billingDetail}</div>
        </div>
        <div class="sub-price">
          <div class="sub-price-value" style="color:${s.color}">${formatPrice(s.price)}</div>
          <div class="sub-price-cycle">${getCycleLabel(s.cycle)}</div>
        </div>
        <div class="sub-actions">
          <button class="btn-icon toggle" onclick="event.stopPropagation(); toggleSub('${s.id}')" title="${s.active === false ? t('statusActive') : t('statusInactive')}">${s.active === false ? 'üîï' : 'üîî'}</button>
          <button class="btn-icon edit" onclick="event.stopPropagation(); editSub('${s.id}')" title="Edit">‚úèÔ∏è</button>
          <button class="btn-icon" onclick="event.stopPropagation(); deleteSub('${s.id}')" title="Delete">üóëÔ∏è</button>
        </div>
      </div>
    `}).join('');
  }

  updateSummary();
}

function updateSummary() {
  let monthly = 0;
  const activeSubs = subscriptions.filter(s => s.active !== false);
  activeSubs.forEach(s => {
    if (s.cycle === 'monthly') monthly += s.price;
    else if (s.cycle === 'yearly') monthly += Math.round(s.price / 12);
    else if (s.cycle === 'weekly') monthly += s.price * 4;
  });

  document.getElementById('totalMonthly').textContent = formatPrice(monthly);
  document.getElementById('totalYearly').textContent = formatPrice(monthly * 12);
  document.getElementById('totalCount').textContent = activeSubs.length;
  document.getElementById('inactiveCount').textContent = subscriptions.length - activeSubs.length;
}

// Modal
function openModal() {
  document.getElementById('modalTitle').textContent = t('modalAdd');
  document.getElementById('editId').value = '';
  document.getElementById('subName').value = '';
  document.getElementById('subPrice').value = '15000';
  document.getElementById('subCycle').value = 'monthly';
  document.getElementById('subCategory').value = 'entertainment';
  document.getElementById('subBillingDay').value = '10';
  document.getElementById('subEmoji').value = '';
  document.getElementById('subMemo').value = '';
  selectColor('#6c5ce7');
  setActiveStatus(true);
  document.getElementById('statusGroup').style.display = 'none';
  document.querySelector('.btn-save').onclick = saveSub;
  document.getElementById('modalOverlay').classList.add('active');
}

function editSub(id) {
  const s = subscriptions.find(x => x.id === id);
  if (!s) return;
  document.getElementById('modalTitle').textContent = t('modalEdit');
  document.getElementById('editId').value = id;
  document.getElementById('subName').value = s.name;
  document.getElementById('subPrice').value = s.price;
  document.getElementById('subCycle').value = s.cycle;
  document.getElementById('subCategory').value = s.category;
  document.getElementById('subBillingDay').value = s.billingDay;
  document.getElementById('subEmoji').value = s.emoji;
  document.getElementById('subMemo').value = s.memo || '';
  selectColor(s.color);
  setActiveStatus(s.active !== false);
  document.getElementById('statusGroup').style.display = '';
  document.querySelector('.btn-save').onclick = saveSub;
  document.getElementById('modalOverlay').classList.add('active');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('active');
}

function selectColor(color) {
  selectedColor = color;
  document.querySelectorAll('.color-option').forEach(c => {
    c.classList.toggle('selected', c.dataset.color === color);
  });
}

function setActiveStatus(active) {
  selectedActive = active;
  const toggle = document.getElementById('statusToggle');
  const label = toggle.querySelector('.status-toggle-label');
  toggle.classList.toggle('active', active);
  label.textContent = active ? t('statusActive') : t('statusInactive');
}

function toggleStatus() {
  setActiveStatus(!selectedActive);
}

function setFilter(f) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.filter === f);
  });
  render();
}

// Theme
function toggleTheme() {
  const html = document.documentElement;
  const isLight = html.getAttribute('data-theme') === 'light';
  html.setAttribute('data-theme', isLight ? 'dark' : 'light');
  document.getElementById('themeBtn').textContent = isLight ? 'üåô' : '‚òÄÔ∏è';
  localStorage.setItem('theme', isLight ? 'dark' : 'light');
}

(function initTheme() {
  const saved = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', saved);
  document.getElementById('themeBtn').textContent = saved === 'light' ? '‚òÄÔ∏è' : 'üåô';
})();

// Helpers
function formatPrice(n) {
  return '‚Ç©' + n.toLocaleString('ko-KR');
}

function getCycleLabel(c) {
  return t('cycleLabel')[c] || '';
}

function getCategoryLabel(c) {
  return t('catLabel')[c] || c;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// Keyboard
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
});

// Init language
(function initLang() {
  currentLang = localStorage.getItem('lang') || 'en';
  applyTranslations();
})();

// Init data
fetchSubs();
</script>
</body>
</html>
